---
/**
 * SanityImage component for rendering native Sanity image assets
 * Used for images that have been uploaded to Sanity's CDN
 */
import { urlFor } from '../utils/image';

// astro-portabletext passes the block data as `node`
const { node } = Astro.props;

// Sanity image has asset._ref pointing to the image asset
const asset = node?.asset;
const alt = node?.alt || '';
const caption = node?.caption || '';
const inlineStyle = node?.inlineStyle || '';
const width = node?.width || '';
const height = node?.height || '';

// Detect alignment from inline style if not explicitly set
let alignment = node?.alignment || 'center';
if (!node?.alignment && inlineStyle) {
  if (inlineStyle.includes('float: right') || inlineStyle.includes('float:right')) {
    alignment = 'right';
  } else if (inlineStyle.includes('float: left') || inlineStyle.includes('float:left')) {
    alignment = 'left';
  }
}

// Check if the image is floated (needs special handling for text wrapping)
const isFloated = alignment === 'left' || alignment === 'right' || 
  inlineStyle.includes('float:') || inlineStyle.includes('float ');

// Generate the URL using Sanity's image builder
let imageUrl = '';
if (asset?._ref) {
  try {
    // If we have a width specified, use that; otherwise default to 800
    const imgWidth = width ? parseInt(width.replace('px', '').replace('%', '')) : 800;
    imageUrl = urlFor(node).width(imgWidth > 0 && imgWidth < 2000 ? imgWidth : 800).auto('format').url();
  } catch (e) {
    console.error('Failed to generate Sanity image URL:', e);
  }
}

// Determine the CSS class based on alignment
const alignmentClass = alignment === 'left' 
  ? 'sanity-image--left' 
  : alignment === 'right' 
    ? 'sanity-image--right' 
    : 'sanity-image--center';

// Build the style string from width/height or use the original inline style
let imgStyle = inlineStyle;
if (!imgStyle) {
  const styleParts: string[] = [];
  if (width) styleParts.push(`width: ${width}`);
  if (height) styleParts.push(`height: ${height}`);
  imgStyle = styleParts.join('; ');
}

// For floated images, apply the style to the container
const containerStyle = isFloated ? imgStyle : undefined;
const imageStyle = isFloated ? undefined : imgStyle;
---

{imageUrl && isFloated ? (
  <!-- Floated images: apply style directly to a span wrapper to preserve float behavior -->
  <span class={`sanity-image-inline ${alignmentClass}`} style={containerStyle}>
    <img 
      src={imageUrl} 
      alt={alt} 
      loading="lazy"
      width={width ? width.replace('px', '').replace('%', '') : undefined}
      height={height ? height.replace('px', '').replace('%', '') : undefined}
    />
    {caption && <span class="image-caption">{caption}</span>}
  </span>
) : imageUrl && (
  <figure class={`sanity-image ${alignmentClass}`}>
    <img 
      src={imageUrl} 
      alt={alt} 
      loading="lazy"
      style={imageStyle || undefined}
      width={!imageStyle && width ? width.replace('px', '') : undefined}
      height={!imageStyle && height ? height.replace('px', '') : undefined}
    />
    {caption && <figcaption>{caption}</figcaption>}
  </figure>
)}

<style>
  .sanity-image {
    margin: 1.5rem 0;
  }
  
  .sanity-image img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
  }
  
  .sanity-image figcaption {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #666;
    text-align: center;
  }

  /* Center aligned (default) */
  .sanity-image--center {
    text-align: center;
  }
  
  .sanity-image--center img {
    margin: 0 auto;
    display: block;
  }

  /* Block-level floated images */
  .sanity-image.sanity-image--left {
    float: left;
    margin: 0 1.5rem 1rem 0;
    max-width: 50%;
  }
  
  .sanity-image.sanity-image--left img {
    max-width: 100%;
  }

  .sanity-image.sanity-image--right {
    float: right;
    margin: 0 0 1rem 1.5rem;
    max-width: 50%;
  }
  
  .sanity-image.sanity-image--right img {
    max-width: 100%;
  }

  /* Inline floated images - uses original HubSpot styles */
  .sanity-image-inline {
    display: inline-block;
  }
  
  .sanity-image-inline img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
  }
  
  .sanity-image-inline .image-caption {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #666;
    text-align: center;
  }

  /* Fallback float styles if inline style not applied */
  .sanity-image-inline.sanity-image--left {
    float: left;
    margin: 0 1.5rem 1rem 0;
  }
  
  .sanity-image-inline.sanity-image--right {
    float: right;
    margin: 0 0 1rem 1.5rem;
  }

  /* Clear floats after content */
  .sanity-image--left + *,
  .sanity-image--right + * {
    clear: none;
  }
</style>

