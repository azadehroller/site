---
import { formatDate } from "../utils";
import type { Post } from "../utils/sanity";

interface Props {
  post: Post;
}

const { post } = Astro.props;

// Use publishedAt if available, otherwise fall back to _createdAt
const displayDate = post.publishedAt || post._createdAt;

// Get first topic if available (filter out null references)
const firstTopic = post.topics?.filter(t => t != null)?.[0];

// Calculate reading time (rough estimate: 200 words per minute)
function estimateReadingTime(body: any[]): number {
  if (!body) return 1;
  let textContent = '';
  for (const block of body || []) {
    if (block._type === 'block' && block.children) {
      textContent += block.children.map((c: any) => c.text || '').join(' ');
    } else if (block._type === 'rawHtml' && block.html) {
      textContent += block.html.replace(/<[^>]*>/g, ' ');
    }
  }
  const wordCount = textContent.split(/\s+/).filter(Boolean).length;
  return Math.max(1, Math.ceil(wordCount / 200));
}
---

<article class="blog-index__post">
  {
    post.featuredImage?.asset?.url ? (
      <a href={`/blog/${post.slug.current}`} class="blog-index__post-image">
        <img
          src={post.featuredImage.asset.url}
          alt={post.featuredImage.alt || post.title || ""}
          loading="lazy"
        />
      </a>
    ) : (
      <a href={`/blog/${post.slug.current}`} class="blog-index__post-image blog-index__post-image--placeholder">
        <div class="placeholder-icon">
          <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
      </a>
    )
  }
  <div class="blog-index__post-content">
    {firstTopic && (
      <a class="blog-header__tag" href={`/blog/topic/${firstTopic.slug?.current}`}>
        {firstTopic.name}
      </a>
    )}
    <h3 class="blog-index__post-title">
      <a href={`/blog/${post.slug.current}`}>
        {post.title}
      </a>
    </h3>
    <p class="blog-index__post-date text-secondary">
      <time datetime={displayDate}>
        {formatDate(displayDate)}
      </time>
      <span> | </span>
      <span class="blog-post__readingtime">
        <span class="blog-post__readingtime-icon">
          <svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M6 .667h4V2H6V.667Zm1.333 8.666v-4h1.334v4H7.333Zm5.354-4.406.946-.947c-.286-.34-.6-.66-.94-.94l-.946.947A5.975 5.975 0 0 0 8 2.667a6 6 0 1 0 6 6 5.975 5.975 0 0 0-1.313-3.74Zm-9.354 3.74A4.663 4.663 0 0 0 8 13.333a4.663 4.663 0 0 0 4.667-4.666A4.663 4.663 0 0 0 8 4a4.663 4.663 0 0 0-4.667 4.667Z" fill="#033180" />
          </svg>
        </span>
        {estimateReadingTime(post.body || [])} min
      </span>
    </p>
  </div>
</article>

<style>
  /* Card styles matching HubSpot blog-article.html */
  .blog-index__post {
    width: 100%;
    border-radius: 10px;
    box-shadow: 0 24px 40px 0 rgba(7, 77, 197, 0.1), 0 8px 16px 0 rgba(7, 77, 197, 0.05);
    background-color: var(--white, #fff);
    padding: 0;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .blog-index__post:hover {
    box-shadow: 0 24px 60px 0 rgba(7, 77, 197, 0.2), 0 8px 24px 0 rgba(7, 77, 197, 0.15);
    transform: translateY(-4px);
  }

  .blog-index__post-image {
    display: block;
    transition: filter 0.2s, transform 0.2s;
  }

  .blog-index__post-image img {
    border-radius: 4px 4px 0 0;
    height: auto;
    max-height: 380px;
    object-fit: cover;
    width: 100%;
    aspect-ratio: 16 / 9;
  }

  .blog-index__post-image--placeholder {
    background: #f8fafc;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .placeholder-icon {
    color: #cbd7ee;
  }

  .blog-index__post-content {
    padding: 24px;
  }

  .blog-header__tag {
    color: rgb(255, 41, 12);
    text-decoration: none;
    font-weight: 800;
    font-size: 14px;
    display: inline-block;
    margin-bottom: 8px;
  }

  .blog-header__tag:hover {
    text-decoration: underline;
  }

  .blog-index__post-title {
    font-size: 18px;
    margin: 10px 0;
  }

  .blog-index__post-title a {
    color: #033180;
    text-decoration: none;
    transition: all 0.3s ease-in-out;
  }

  .blog-index__post-title a:hover {
    text-decoration: underline;
  }

  .blog-index__post-date {
    font-size: 0.875rem;
    margin-bottom: 0;
    display: flex;
    gap: 0.5rem;
    margin: 0 0 8px;
    color: #033180;
  }

  .blog-post__readingtime {
    display: inline-flex;
    align-items: center;
  }

  .blog-post__readingtime-icon {
    display: inline-flex;
    align-items: center;
    padding-right: 4px;
  }

  .text-secondary {
    color: #757382;
  }
</style>

