---
/**
 * HubSpot Form Component
 * Based on custom-form.module from HubSpot
 * 
 * The only difference from the HubSpot module is that the form
 * is selected from global forms in Sanity instead of a HubSpot module field.
 */

import { cleanStega } from "../../utils/stega";

interface Props {
  // Form configuration from Sanity global forms
  portalId: string;
  formId: string;
  region?: string;
  formName?: string;
  // Style options
  theme?: 'light' | 'dark';
}

const {
  portalId,
  formId,
  region = 'na1',
  formName,
  theme = 'light',
} = Astro.props;

// Clean stega values
const cleanPortalId = cleanStega(portalId);
const cleanFormId = cleanStega(formId);
const cleanRegion = cleanStega(region);
const cleanTheme = cleanStega(theme);

// Generate unique target ID for this form instance
const formTargetId = `hsForm-${cleanFormId?.replace(/-/g, '').substring(0, 12) || Math.random().toString(36).substring(2, 10)}`;

// Determine if dark mode
const isDarkMode = cleanTheme === 'dark';
---

<div class:list={["form-wrapper", { "dark-mode": isDarkMode }]}>
  <div 
    id={formTargetId} 
    class="hs-form-target"
    data-portal-id={cleanPortalId}
    data-form-id={cleanFormId}
    data-region={cleanRegion}
  ></div>
</div>

<style>
  /* Base form wrapper - matches HubSpot module structure */
  .form-wrapper {
    position: relative;
    width: 100%;
  }

  .hs-form-target {
    /* Target container for HubSpot form */
    width: 100%;
    min-height: 50px;
  }
</style>

<style is:global>

form {
    font-family: 'proxima-nova',sans-serif;
    margin-top: 2rem
}

@media (min-width: 992px) {
    form {
        margin-top:0
    }
}

.hs-form-field {
    margin-bottom: 1.5rem
}

form label {
    color: var(--m-3-scout-navy-30,#053994);
    font-size: .875rem;
    font-style: normal;
    font-weight: 600;
    line-height: 1.125rem;
    display: block;
    padding-top: 0;
    text-align: left;
    width: auto
}

form legend {
    color: var(--neutral-60);
    font-size: var(--formFontSize,16px)
}

.input {
    position: relative
}

form input[type='text'],form input[type='search'],form input[type='email'],form input[type='password'],form input[type='tel'],form input[type='number'],form input[type='file'],form select,form textarea {
    background-color: #fff0;
    border-bottom: 1px solid var(--m-3-scout-navy-80,#9dbffb);
    border-radius: 0;
    color: var(--m-3-scout-navy-80,#053994);
    font-weight: 500;
    display: inline-block;
    font-size: var(--formFontSize,16px);
    line-height: 1.4;
    padding: .5rem 0rem;
    width: 100%!important
}

form input[type='text']::-moz-placeholder,form input[type='search']::-moz-placeholder,form input[type='email']::-moz-placeholder,form input[type='password']::-moz-placeholder,form input[type='tel']::-moz-placeholder,form input[type='number']::-moz-placeholder,form input[type='file']::-moz-placeholder,form select::-moz-placeholder,form textarea::-moz-placeholder {
    color: var(--m-3-scout-navy-80,#9dbffb)
}

form input[type='text']:-ms-input-placeholder,form input[type='search']:-ms-input-placeholder,form input[type='email']:-ms-input-placeholder,form input[type='password']:-ms-input-placeholder,form input[type='tel']:-ms-input-placeholder,form input[type='number']:-ms-input-placeholder,form input[type='file']:-ms-input-placeholder,form select:-ms-input-placeholder,form textarea:-ms-input-placeholder {
    color: var(--m-3-scout-navy-80,#9dbffb)
}

form input[type='text']::placeholder,form input[type='search']::placeholder,form input[type='email']::placeholder,form input[type='password']::placeholder,form input[type='tel']::placeholder,form input[type='number']::placeholder,form input[type='file']::placeholder,form select::placeholder,form textarea::placeholder {
    color: var(--m-3-scout-navy-80,#9dbffb)
}

form input[type='text']:focus,form input[type='search']:focus,form input[type='email']:focus,form input[type='password']:focus,form input[type='tel']:focus,form input[type='number']:focus,form input[type='file']:focus,form select:focus,form textarea:focus {
    outline: 0;
    border-bottom: 1px solid var(--m-3-scout-navy-80,#053994)
}

input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance: none
}

form textarea {
    resize: none;
    height: 9rem;
    border: 1px solid var(--m-3-scout-navy-80,#9dbffb);
    border-radius: .375rem;
    display: flex;
    padding: .5rem .75rem;
    margin: .5rem 0;
    align-items: flex-start;
    gap: .75rem;
    flex: 1 0 0%;
    align-self: stretch;
    color: var(--m-3-scout-navy-80,#053994)
}

form textarea::-moz-placeholder {
    color: var(--m-3-scout-navy-80,#9dbffb)
}

form textarea:-ms-input-placeholder {
    color: var(--m-3-scout-navy-80,#9dbffb)
}

form textarea::placeholder {
    color: var(--m-3-scout-navy-80,#9dbffb)
}

form textarea:focus {
    outline: 0;
    border: 1px solid var(--m-3-scout-navy-80,#053994)
}

form fieldset {
    max-width: 100%!important
}

form select {
    padding: .5rem 0;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M13.825 6.91248L10 10.7291L6.175 6.91248L5 8.08748L10 13.0875L15 8.08748L13.825 6.91248Z' fill='%23053994'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: 100% center
}

form .inputs-list {
    margin: 0;
    padding: 0;
    list-style: none
}

form .inputs-list>li {
    display: block;
    margin: .7rem 0
}

form .inputs-list input,form .inputs-list span {
    vertical-align: middle
}

form input[type='checkbox'],form input[type='radio'] {
    cursor: pointer;
    margin-right: .35rem
}

.hs-dateinput {
    position: relative
}

.hs-dateinput:before {
    content: '\01F4C5';
    position: absolute;
    right: 10%;
    top: 50%;
    transform: translateY(-50%)
}

.fn-date-picker .pika-table thead th {
    color: #fff
}

.fn-date-picker td.is-selected .pika-button {
    border-radius: 0;
    box-shadow: none
}

.fn-date-picker td .pika-button:hover,.fn-date-picker td .pika-button:focus {
    border-radius: 0!important;
    color: #fff
}

form input[type='file'] {
    background-color: #fff0;
    border: initial;
    padding: initial
}

form .hs-richtext,form .hs-richtext p {
    font-size: .875rem;
    margin: 0 0 1.4rem
}

form .hs-richtext img {
    max-width: 100%!important
}

.legal-consent-container .hs-form-booleancheckbox-display>span,.legal-consent-container .hs-form-booleancheckbox-display>span p {
    margin-left: 1rem!important
}

.hs-form-required {
    color: var(--secondary-50)
}

.hs-input {
    width: 100%!important
}

.hs-input.invalid.error {
    border-color: var(--secondary-50)
}

.hs-error-msg {
    color: var(--secondary-50);
    margin-top: .35rem
}

form .hs-submit {
    display: flex
}

form input[type='submit'],form .hs-button {
    background-color: var(--secondary-50);
    border-radius: 1.5rem;
    color: var(--neutral-white,#143d82);
    cursor: pointer;
    display: inline-block;
    font-size: var(--formFontSize,16px);
    font-weight: 600;
    height: auto;
    line-height: 1.4;
    margin: 0;
    padding: .5rem 1.5rem;
    position: relative;
    text-align: center;
    text-decoration: none;
    transition: all 0.15s linear;
    white-space: nowrap!important;
    width: auto;
    word-break: break-word
}

.hs-firstname,.hs-lastname {
    width: 100%!important
}

@media (min-width: 992px) {
    .hs-firstname,.hs-lastname {
        width:50%!important
    }
}

form input[type='submit']:hover,form .hs-button:hover {
    background-color: var(--secondary-70)
}

.actions {
    text-align: center
}

form .hs_recaptcha {
    margin: 24px 0 32px
}

  /* ===================================== */
  /* DARK MODE STYLES */
  /* From custom-form.module/module.css */
  /* ===================================== */
  .form-wrapper.dark-mode .hs-custom-form {
    position: relative;

    label {
      color: var(--neutral-white);
    }

    & input[type='text'],
    & input[type='search'],
    & input[type='email'],
    & input[type='password'],
    & input[type='tel'],
    & input[type='number'],
    & input[type='file'],
    & select,
    & textarea {
      &:not(.error) {
        border-bottom: 1px solid var(--blue--40, #074DC5);
      }
      border-bottom: 1px solid #FF290C;
      color: var(--neutral-white);
      caret-color: #FF290C;

      &::placeholder {
        color: var(--blue--40, #074DC5);
      }
    }

    .hs-error-msg.hs-main-font-element {
      color: var(--red-error-30, #FF8080);
    }

    & .form-columns-2 {
      display: flex;
      gap: 32px;
    }

    & .input {
      margin-right: 0 !important;
    }

    input[type='text'],
    input[type='search'],
    input[type='email'],
    input[type='password'],
    input[type='tel'],
    input[type='number'],
    input[type='file'],
    select,
    textarea {
      &:focus {
        border-bottom: 1px solid #9DBFFB;
      }

      &.invalid {
        border-bottom: 1px solid #FF290C;
      }
    }
  }
</style>

<script is:inline>
  // Load HubSpot Forms script once
  if (!window.hubspotFormsLoaded) {
    window.hubspotFormsLoaded = true;
    var script = document.createElement('script');
    script.src = '//js.hsforms.net/forms/embed/v2.js';
    script.charset = 'utf-8';
    script.async = true;
    document.head.appendChild(script);
  }

  // Track initialized forms to prevent double initialization
  if (!window.hubspotFormsInitialized) {
    window.hubspotFormsInitialized = {};
  }

  // URL parameter helper (from original HubSpot module)
  var getUrlParameters = function(url, names) {
    if (!Array.isArray(names)) {
      console.error('Names must be an array');
      return {};
    }
    
    var params = {};
    var searchParams = new URLSearchParams(url.search);

    names.forEach(function(name) {
      var value = searchParams.get(name);
      params[name] = value !== null ? value : null;
    });
    
    return params;
  };

  // Set input values from URL params (from original HubSpot module)
  var setInputValues = function(formInputs, formValues) {
    formInputs.forEach(function(inputName) {
      var el = document.querySelector('input[name="' + inputName + '"]');
      if (el && formValues[inputName]) {
        el.value = formValues[inputName];
      }
    });
  };

  // Form ready callback (from original HubSpot module)
  var onFormReady = function() {
    var url = new URL(window.location.href);
    var params = getUrlParameters(url, ['customer_ref_id', 'promo_code']);
    setInputValues(['customer_ref_id', 'promo_code'], params);
  };

  // Initialize all HubSpot forms on the page
  var initHubSpotForms = function() {
    var formTargets = document.querySelectorAll('.hs-form-target');
    
    formTargets.forEach(function(target) {
      var targetId = target.id;
      
      // Skip if already initialized
      if (window.hubspotFormsInitialized[targetId]) {
        return;
      }
      
      var portalId = target.getAttribute('data-portal-id');
      var formId = target.getAttribute('data-form-id');
      var region = target.getAttribute('data-region') || 'na1';
      
      if (portalId && formId && window.hbspt) {
        // Mark as initialized
        window.hubspotFormsInitialized[targetId] = true;
        
        try {
          window.hbspt.forms.create({
            portalId: portalId,
            formId: formId,
            region: region,
            target: '#' + targetId,
            cssClass: 'hs-form stacked hs-custom-form',
            onFormReady: onFormReady
          });
        } catch (error) {
          console.log('Hubspot error: ', error);
          // Remove from initialized so it can retry
          delete window.hubspotFormsInitialized[targetId];
        }
      }
    });
  };

  // Wait for HubSpot script to load
  var waitForHubSpot = function() {
    if (window.hbspt && window.hbspt.forms) {
      initHubSpotForms();
    } else {
      setTimeout(waitForHubSpot, 100);
    }
  };

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForHubSpot);
  } else {
    waitForHubSpot();
  }
</script>
