---
/**
 * IndustrySelector - A grid of industry links with icons
 * Based on FeaturesSelector structure
 * Uses HeadingComposition for the header section
 * Supports Lottie animations for icons
 */
import { cleanStega } from "../../utils/stega";
import HeadingComposition from "./HeadingComposition.astro";
import type { PortableTextBlock } from "@portabletext/types";
import type { HeadingComposition as HeadingCompositionType } from "../../utils/sanity";

interface IndustryLink {
  href?: string;
  openInNewTab?: boolean;
  noFollow?: boolean;
}

interface AnimationFile {
  asset?: {
    url?: string;
  };
}

interface IndustryItem {
  _key?: string;
  icon?: string;
  animationFile?: AnimationFile;
  title?: string;
  link?: IndustryLink;
}

interface Props {
  // Heading - uses HeadingComposition type with all its fields
  heading?: HeadingCompositionType;
  // Industries
  industries?: IndustryItem[];
  // CTA
  ctaLabel?: string;
  ctaLink?: IndustryLink;
  id?: string;
  // Theme
  theme?: 'light' | 'dark';
}

const {
  heading,
  industries = [],
  ctaLabel = 'See all industries',
  ctaLink,
  id = 'industry-selector',
  theme = 'dark'
} = Astro.props;

// Generate unique ID for component
const componentId = cleanStega(id) || `industry-selector-${Math.random().toString(36).slice(2, 9)}`;

// Check if heading has any content
const hasHeading = heading?.eyebrow || heading?.title || (heading?.text && heading.text.length > 0);

// CTA link data
const ctaHref = cleanStega(ctaLink?.href) || '/industries';
const ctaOpenInNewTab = ctaLink?.openInNewTab;
const ctaNoFollow = ctaLink?.noFollow;

// Build rel attribute for CTA
const ctaRelParts: string[] = [];
if (ctaNoFollow) ctaRelParts.push('nofollow');
if (ctaOpenInNewTab) ctaRelParts.push('noopener');
const ctaRel = ctaRelParts.length > 0 ? ctaRelParts.join(' ') : undefined;

// Check if any industry has Lottie animation
const hasLottieAnimations = industries.some(industry => industry.animationFile?.asset?.url);

// Debug: Log industries data to see what's coming from Sanity
console.log('[IndustrySelector] Industries data:', JSON.stringify(industries.map(i => ({
  title: i.title,
  hasIcon: !!i.icon,
  animationFile: i.animationFile
})), null, 2));
---

<div
  id={componentId}
  class:list={[
    "industry-selector mx-auto gap-5 rounded-[32px] py-6 px-6 mb-0 md:mb-4",
    theme === 'light'
      ? "bg-widget-industries  box-shadow-ondark-blue-10 flex flex-col lg:grid lg:grid-cols-3"
      : " box-shadow-onlight bg-primary-50 flex flex-col lg:p-6"
  ]}
  data-sanity-edit-target
>
  {/* Header Section using HeadingComposition */}
  {hasHeading && heading && (
    <header class:list={[
      "grid gap-4",
      theme === 'light' ? "text-primary-50 flex flex-col" : " text-neutral-white "
    ]} data-sanity-edit-target>
      <HeadingComposition
        eyebrow={heading.eyebrow}
        title={heading.title}
        text={heading.text}
        theme={heading.theme}
        textAlignment={heading.textAlignment}
        eyebrowType={heading.eyebrowType}
        eyebrowStyle={heading.eyebrowStyle}
        headingType={heading.headingType}
        displayType={heading.displayType}
        textType={heading.textType}
        addBorderLine={heading.addBorderLine}
      />
      {theme === 'light' && (
        <img
          src="/images/industry-selector-graph.svg"
          alt={heading.title || "Industry Selector"}
          width="368"
          height="368"
          class="hidden lg:block mt-4"
        />
      )}
    </header>
  )}

  {/* Desktop grid view */}
  <div class:list={[
    "hidden md:flex flex-wrap gap-3 ms-auto me-auto",
    theme === 'light' ? "col-span-2" : "dark"
  ]}>
    {industries.map((industry) => {
      const industryTitle = industry.title;
      const industryIcon = industry.icon;
      const lottieUrl = industry.animationFile?.asset?.url;
      const href = cleanStega(industry.link?.href) || '/';
      const openInNewTab = industry.link?.openInNewTab;
      const noFollow = industry.link?.noFollow;

      // Build rel attribute
      const relParts: string[] = [];
      if (noFollow) relParts.push('nofollow');
      if (openInNewTab) relParts.push('noopener');
      const rel = relParts.length > 0 ? relParts.join(' ') : undefined;

      return (
        <a
          href={href}
          class:list={[
            "industry-item-link flex items-center justify-center gap-2 mo-card-features font-semibold ease-in transition duration-200 hover:bg-neutral-white hover:shadow-[var(--shadow-on-dark-bg)] hover:bg-white  rounded-2xl",
            theme === 'light' ? "text-primary-50 hover:text-neutral-white" : "text-neutral-white hover:text-primary-50"
          ]}
          target={openInNewTab ? '_blank' : undefined}
          rel={rel}
          data-sanity-edit-target
        >
          {/* Lottie animation container - takes priority over SVG icon */}
          {lottieUrl ? (
            <div 
              class="lottie-container" 
              data-lottie-src={lottieUrl}
              data-sanity-edit-target
            />
          ) : industryIcon && (
            <span class="industry-icon" set:html={industryIcon} data-sanity-edit-target />
          )}
          <span data-sanity-edit-target>{industryTitle}</span>
        </a>
      );
    })}
  </div>

  {/* Mobile dropdown view - data-sanity-ignore prevents Visual Editing from intercepting clicks */}
  <div class="grid gap-3 md:hidden dropdown-wrapper" data-sanity-ignore>
    <select 
      id={`${componentId}-dropdown`}
      class="industry-dropdown bg-neutral-white box-shadow-onlight-navy-40 text-primary-50 font-semibold text-center rounded-[61.25rem] py-2 px-4 w-full appearance-none cursor-pointer"
      data-sanity-ignore
    >
      <option value="" selected>Select your industry</option>
      {industries.map((industry) => {
        const industryTitle = cleanStega(industry.title);
        const href = cleanStega(industry.link?.href) || '/';
        return (
          <option value={href}>{industryTitle}</option>
        );
      })}
    </select>
    <button 
      type="button"
      class="industry-discover-btn relative items-center cursor-pointer select-none appearance-none no-underline tracking-tight leading-6 font-semibold transition ease-in-out duration-300 bg-secondary-50 hover:bg-secondary-70 rounded-3xl py-2 px-4 text-neutral-white"
      data-dropdown-id={`${componentId}-dropdown`}
    >
      Discover
    </button>
  </div>

</div>

<style>
  /* Container shadows */
  .box-shadow-onlight {
    box-shadow: 0px 4px 8px 0px rgba(3, 49, 128, 0.08), 0px 12px 24px 0px rgba(3, 49, 128, 0.12);
  }

  .box-shadow-ondark-blue-10 {
    box-shadow: 0px 8px 16px 0px rgba(1, 19, 50, 0.25), 0px 24px 40px 0px rgba(1, 19, 50, 0.50);
  }

  .box-shadow-ondark-blue-10:hover {
    box-shadow: 0px 8px 16px 0px rgba(1, 19, 50, 0.25), 0px 24px 40px 0px rgba(1, 19, 50, 0.50);
  }

  .box-shadow-onlight-navy-40 {
    box-shadow: 0 4px 6px -1px rgba(1, 24, 64, 0.1), 0 2px 4px -2px rgba(1, 24, 64, 0.1);
  }

  /* Dropdown wrapper with custom arrow */
  .dropdown-wrapper {
    position: relative;
    isolation: isolate;
    z-index: 9999;
  }

  .dropdown-wrapper::after {
    content: "";
    position: absolute;
    top: 24px;
    right: 20px;
    transform: translateY(-50%);
    width: 0.7em;
    height: 0.4em;
    background-color: var(--primary-50, #033180);
    clip-path: polygon(100% 0%, 0 0%, 50% 100%);
    pointer-events: none;
    z-index: 0;
  }

  /* Disable Sanity Visual Editing overlays on dropdown */
  .dropdown-wrapper :global([data-sanity-overlay]),
  .dropdown-wrapper :global([class*="StyledBox"]),
  .dropdown-wrapper :global([class*="StyledCard"]),
  .dropdown-wrapper :global([class*="sc-"]) {
    pointer-events: none !important;
    display: none !important;
  }

  /* Industry item cards */
  .mo-card-features {
    padding: 0.75rem 1.25rem;
    min-height: 56px;
  }

  /* Background colors */
  .bg-widget-industries {
    background-image: linear-gradient(100deg, #FFF 0%, #F5F8FF 61.98%);
  }

  /* Icon container */
  .industry-icon {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .industry-icon :global(svg) {
    width: 64px;
    height: 64px;
  }

  /* Lottie animation container */
  .lottie-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    overflow: hidden;
  }

  .lottie-container :global(svg) {
    width: 100%;
    height: 100%;
  }

  /* Dropdown styles */
  .industry-dropdown {
    border: none;
    outline: none;
    position: relative;
    z-index: 1;
    pointer-events: auto !important;
    transform: translateZ(0);
    -webkit-appearance: none;
    -moz-appearance: none;
  }

  .industry-dropdown:focus {
    box-shadow: 0 0 0 2px var(--primary-40, #074DC5);
  }

</style>

<script is:inline>
(function() {
  'use strict';

  // Handle dropdown navigation
  document.querySelectorAll('.industry-discover-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const dropdownId = btn.getAttribute('data-dropdown-id');
      const dropdown = document.getElementById(dropdownId);
      if (dropdown && dropdown.value) {
        window.location.assign(dropdown.value);
      }
    });
  });

  // Fix for Sanity Visual Editing blocking select elements
  // Create a transparent overlay that captures clicks and opens the select
  document.querySelectorAll('.industry-dropdown').forEach(function(select) {
    const wrapper = select.closest('.dropdown-wrapper');
    if (!wrapper) return;

    // Create an invisible button overlay
    const overlay = document.createElement('button');
    overlay.type = 'button';
    overlay.className = 'select-click-overlay';
    overlay.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 48px; background: transparent; border: none; cursor: pointer; z-index: 10001;';
    overlay.setAttribute('aria-label', 'Open dropdown');
    
    wrapper.style.position = 'relative';
    wrapper.insertBefore(overlay, select);

    overlay.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // Try showPicker() for modern browsers
      if (typeof select.showPicker === 'function') {
        try {
          select.showPicker();
        } catch (err) {
          // Fallback: focus and simulate click
          select.focus();
        }
      } else {
        // Fallback for older browsers
        select.focus();
        // Create and dispatch a mouse event
        const event = new MouseEvent('mousedown', {
          bubbles: true,
          cancelable: true,
          view: window
        });
        select.dispatchEvent(event);
      }
    });
  });
})();
</script>

<!-- Lottie Animation Script -->
<script>
  import lottie from 'lottie-web';
  import type { AnimationItem } from 'lottie-web';

  // Store animation instances to prevent duplicate initialization
  const animations = new Map<HTMLElement, AnimationItem>();

  function initLottieAnimations() {
    const lottieContainers = document.querySelectorAll<HTMLElement>('.lottie-container[data-lottie-src]');
    
    console.log('[Lottie] Found containers:', lottieContainers.length);
    
    lottieContainers.forEach((container) => {
      const lottieSrc = container.getAttribute('data-lottie-src');
      if (!lottieSrc) {
        console.log('[Lottie] No src found for container');
        return;
      }

      // Skip if already initialized
      if (animations.has(container)) {
        console.log('[Lottie] Container already initialized');
        return;
      }

      console.log('[Lottie] Loading animation from:', lottieSrc);

      // Load the Lottie animation
      const animation = lottie.loadAnimation({
        container: container,
        renderer: 'svg',
        loop: true,
        autoplay: false,
        path: lottieSrc,
      });

      // Log when animation is loaded
      animation.addEventListener('DOMLoaded', () => {
        console.log('[Lottie] Animation loaded successfully');
      });

      animation.addEventListener('data_failed', () => {
        console.error('[Lottie] Failed to load animation data from:', lottieSrc);
      });

      // Store animation reference
      animations.set(container, animation);

      // Find parent link for hover events
      const parentLink = container.closest('.industry-item-link');
      if (parentLink) {
        // Play animation on hover
        parentLink.addEventListener('mouseenter', () => {
          console.log('[Lottie] Playing animation');
          animation.play();
        });

        // Stop animation on mouse leave
        parentLink.addEventListener('mouseleave', () => {
          console.log('[Lottie] Stopping animation');
          animation.stop();
        });
      }
    });
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLottieAnimations);
  } else {
    initLottieAnimations();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initLottieAnimations);
</script>

