---
/**
 * StatsSet - A component displaying statistics with numbers and text
 * Matches the HubSpot stats-set.module HTML structure
 * 
 * Features:
 * - Multiple stat items with optional tags, numbers, and rich text
 * - Theme options (OnDark, OnLight)
 * - Text size options
 * - Spacing style options (default, small)
 * - Visual editing support with stega handling
 */
import { cleanStega } from '../../utils/stega';

interface StatItem {
  _key?: string;
  tag?: string;
  statsNumber?: string;
  statsText?: string;
}

interface Props {
  stats?: StatItem[];
  theme?: 'light' | 'dark';
  textType?: '2xl' | 'xl' | 'base' | 'sm' | 'xs';
  spacingStyle?: 'default' | 'small';
  id?: string;
}

const {
  stats: rawStats = [],
  theme: rawTheme = 'dark',
  textType: rawTextType = 'xl',
  spacingStyle: rawSpacingStyle = 'default',
  id,
} = Astro.props;

// Clean stega from style values for CSS classes
const theme = cleanStega(rawTheme) || 'dark';
const textType = cleanStega(rawTextType) || 'xl';
const spacingStyle = cleanStega(rawSpacingStyle) || 'default';

// Preserve stega in visible text for visual editing click-to-edit
const stats = rawStats || [];

// Build text color classes based on theme
const getDivideColorClass = (): string => {
  return theme === 'light' ? 'divide-neutral-white' : 'divide-navy-80';
};

const getTextColorClass = (): string => {
  return theme === 'light' ? 'text-neutral-white' : 'text-primary-50';
};

const divideColorClass = getDivideColorClass();
const textColorClass = getTextColorClass();

/**
 * Sanitize HTML to allow only safe tags
 * Allows: strong, b, em, i, a, br, span
 */
function sanitizeHtml(html: string | undefined): string {
  if (!html) return '';
  
  // First, clean any stega characters but preserve the HTML structure
  let cleaned = html;
  
  // Allow only specific HTML tags, strip everything else
  // This regex keeps: <strong>, </strong>, <b>, </b>, <em>, </em>, <i>, </i>, <a ...>, </a>, <br>, <br/>, <span ...>, </span>
  const allowedTagsRegex = /<(?!\/?(?:strong|b|em|i|a|br|span)\b)[^>]*>/gi;
  cleaned = cleaned.replace(allowedTagsRegex, '');
  
  return cleaned;
}

// Generate a unique ID for this stats set
const statsSetId = id ? cleanStega(id) : `stats-set-${Math.random().toString(36).substr(2, 9)}`;
---

<div id={statsSetId} class="stats-set-module" data-sanity-edit-target>
  <div class={`stats-set-container flex md:grid md:grid-cols-1 lg:flex flex-col md:flex-row justify-center content-center m-auto w-full gap-y-0 divide-y-2 lg:divide-y-0 divide-x-0 lg:divide-x-2 divide-navy-80 ${divideColorClass}`}>
    {stats.map((stat) => {
      const cleanTag = stat.tag;
      const cleanNumber = stat.statsNumber;
      const sanitizedText = sanitizeHtml(stat.statsText);
      
      return (
        <div 
          class={`stats-set ${spacingStyle === 'small' ? 'small-spacing' : ''} flex flex-col items-center gap-2 ps-4 pe-4 text-center py-6 md:py-4 lg:py-0 relative ${textColorClass}`}
          data-sanity-edit-target
        >
          {cleanTag && (
            <div class="stats-set-tag bg-neutral-white flex py-1 px-2">
              <span class="uppercase font-bold text-primary-50">{cleanTag}</span>
            </div>
          )}
          <strong class="stats-set-number font-bold">
            {cleanNumber || '10%'}
          </strong>
          <p 
            class={`stats-set-text text-${textType} md:max-w-[18rem]`}
            set:html={sanitizedText}
          />
        </div>
      );
    })}
  </div>
</div>

<style is:global>
  /* Stats Set Module - Custom styles only (Tailwind handles utilities) */
  
  /* Stats item link styling */
  .stats-set a {
    color: #00b8ff;
    text-decoration: underline;
  }

  .stats-set a:hover {
    text-decoration: none;
  }

  /* Small spacing variant - matches HubSpot module.css */
  .stats-set.small-spacing {
    padding: 2rem 0;
  }

  .stats-set.small-spacing:first-of-type {
    border-top: 2px solid rgb(157 191 251 / var(--tw-divide-opacity, 1));
  }

  .stats-set.small-spacing .stats-set-text:last-child {
    margin-bottom: 0px;
  }

  @media (min-width: 991px) {
    .stats-set.small-spacing {
      padding-inline-start: 1.5rem;
      padding-inline-end: 1.5rem;
    }

    .stats-set.small-spacing:first-of-type {
      border-top: 0;
    }
  }


  /* Stats set number - responsive sizing matching HubSpot */
  .stats-set-number {
    font-size: 2.5rem;
    line-height: 1;
  }

  @media (min-width: 768px) {
    .stats-set-number {
      line-height: 3.75rem;
    }
  }

  @media (min-width: 1024px) {
    .stats-set-number {
      font-size: 4rem;
      line-height: 4.5rem;
    }
  }
</style>

