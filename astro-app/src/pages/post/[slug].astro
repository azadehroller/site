---
import { PortableText } from "astro-portabletext";
import Layout from "../../layouts/Layout.astro";
import { formatDate } from "../../utils";
import { urlFor, isImageReady } from "../../utils/image";
import { getPost } from "../../utils/sanity";

// Disable prerendering to enable SSR for visual editing with draft mode
export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

const { data: post } = await getPost(slug, Astro.request);

if (!post) {
  return Astro.redirect('/');
}
---

<Layout title={post.title!}>
  <section class="my-1 w-full mb-4">
    {
      post.mainImage && isImageReady(post.mainImage) ? (
        <img
          class="h-[200px] w-full object-cover md:h-[380px] md:w-[750px]"
          src={urlFor(post.mainImage).url()}
          alt="Cover image"
        />
      ) : (
        <div class="h-[200px] w-full bg-black md:h-[380px] md:w-[750px]" />
      )
    }
    <div class="px-3">
      <h1 class="my-4 font-sans text-4xl font-extrabold leading-9 md:mb-0 md:mt-6 md:text-7xl md:leading-[72px] md:tracking-tight">{post.title}</h1>
      <p class="mt-0 mb-3 font-serif text-2xl leading-7 md:mt-3 md:leading-8">{post.excerpt}</p>
      <p class="mt-4 font-sans text-sm font-semibold leading-5 md:mt-0 md:text-lg md:leading-6">
        {formatDate(post._createdAt)}
      </p>
      <div class="prose mt-6 font-serif text-xl leading-8 tracking-tight md:mt-20">
        <PortableText value={post.body} />
      </div>
    </div>
  </section>
</Layout>

<style>
  /* Scoped styles for PortableText content */
  .prose :global(blockquote) {
    border-left: 5px solid #101112;
    padding-left: 12px;
    margin-left: 20px;
  }

  .prose :global(a) {
    color: #1e61cd;
    text-decoration: none;
  }

