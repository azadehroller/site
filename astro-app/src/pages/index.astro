---
import Layout from "../layouts/Layout.astro";
import Columns from "../components/blocks/Columns.astro";
import ColumnContent from "../components/blocks/ColumnContent.astro";
import Divider from "../components/blocks/Divider.astro";
import { getHomepage, type ColumnsBlock, type Divider as DividerType } from "../utils/sanity";
import { cleanStega } from "../utils/stega";

const { data: homepage } = await getHomepage(Astro.request);
const title = homepage?.title || "Home";
const sections = homepage?.sections || [];

// Document info for visual editing - enables click-to-edit on nested elements
const documentId = homepage?._id || '';
const documentType = 'homepage';

// Extract LCP image from first section for preloading
// Check column1 of first columnsBlock for imageVideoModal, advancedImage, or image
function findFirstImage(sections: any[]): string | undefined {
  for (const section of sections) {
    if (section._type === 'columnsBlock' && section.column1) {
      for (const item of section.column1) {
        // Check imageVideoModal thumbnail
        if (item._type === 'imageVideoModal' && item.thumbnail?.asset?.url) {
          return item.thumbnail.asset.url;
        }
        // Check advancedImage
        if (item._type === 'advancedImage' && item.image?.asset?.url) {
          return item.image.asset.url;
        }
        // Check regular image
        if (item._type === 'image' && item.asset?.url) {
          return item.asset.url;
        }
      }
    }
  }
  return undefined;
}
const lcpImageUrl = findFirstImage(sections);

// Helper to get divider background color class
const getDividerBgClass = (divider: DividerType): string => {
  const background = cleanStega(divider.background) || 'light';
  if (background === 'light') return 'divider-bg-light';
  
  const darkBgColor = cleanStega(divider.darkBackgroundColor) || 'var(--blue-10)';
  if (darkBgColor === 'var(--blue-30)') return 'divider-bg-blue30';
  return 'divider-bg-blue10';
};
---

<Layout title={title} announcementBar={homepage?.announcementBar} lcpImage={lcpImageUrl}>
  <main class="homepage">
    {sections.length > 0 ? (
      sections.map((section) => {
        if (section._type === 'columnsBlock') {
          const block = section as ColumnsBlock;
          // Pass document and section info for visual editing
          const sectionKey = block._key;
          return (
            <Columns 
              layout={block.layout}
              backgroundColor={block.backgroundColor}
              customBackgroundColor={block.customBackgroundColor}
              backgroundImage={block.backgroundImage?.asset?.url}
              backgroundPosition={block.backgroundPosition}
              backgroundSize={block.backgroundSize}
              backgroundGradient={block.backgroundGradient}
              gradientColorStart={block.gradientColorStart}
              gradientColorEnd={block.gradientColorEnd}
              paddingTop={block.paddingTop}
              paddingTopMobile={block.paddingTopMobile}
              paddingBottom={block.paddingBottom}
              paddingBottomMobile={block.paddingBottomMobile}
              sectionKey={sectionKey}
              documentId={documentId}
              documentType={documentType}
            >
              <ColumnContent 
                slot="col1" 
                content={block.column1} 
                columnName="column1"
                sectionKey={sectionKey}
                documentId={documentId}
                documentType={documentType}
              />
              {block.column2 && <ColumnContent 
                slot="col2" 
                content={block.column2}
                columnName="column2"
                sectionKey={sectionKey}
                documentId={documentId}
                documentType={documentType}
              />}
              {block.column3 && <ColumnContent 
                slot="col3" 
                content={block.column3}
                columnName="column3"
                sectionKey={sectionKey}
                documentId={documentId}
                documentType={documentType}
              />}
              {block.column4 && <ColumnContent 
                slot="col4" 
                content={block.column4}
                columnName="column4"
                sectionKey={sectionKey}
                documentId={documentId}
                documentType={documentType}
              />}
            </Columns>
          );
        } else if (section._type === 'divider') {
          const divider = section as DividerType;
          const bgClass = getDividerBgClass(divider);
          const sectionKey = divider._key;
          return (
            <div 
              class={`dnd-section ${bgClass}`}
              data-sanity-edit-target
            >
              <Divider
                showDivider={divider.showDivider}
                dividerType={divider.dividerType}
                background={divider.background}
                sectionKey={sectionKey}
                documentId={documentId}
                documentType={documentType}
              />
            </div>
          );
        }
      })
    ) : (
      <section class="px-4 sm:px-6 lg:px-8 py-16 max-w-7xl mx-auto text-center">
        <h1 class="text-4xl font-bold mb-4">Welcome</h1>
        <p class="text-lg text-gray-600">
          Add content to your homepage in Sanity Studio.
        </p>
      </section>
    )}
  </main>
</Layout>

<style>
  .homepage {
    min-height: 50vh;
  }
</style>
