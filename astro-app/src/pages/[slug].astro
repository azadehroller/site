---
import Card from "../components/Card.astro";
import Columns from "../components/blocks/Columns.astro";
import ColumnContent from "../components/blocks/ColumnContent.astro";
import Layout from "../layouts/Layout.astro";
import { getPage, getLandingPage, type ColumnsBlock, type Post } from "../utils/sanity";

// SSR enabled for preview/draft mode
export const prerender = false;

const { slug } = Astro.params;

// First try to find a landing page, then fall back to regular page
const { data: landingPage } = await getLandingPage(slug as string, Astro.request);
const { data: regularPage } = landingPage ? { data: null } : await getPage(slug as string, Astro.request);

const page = landingPage || regularPage;

if (!page) {
  return Astro.redirect('/404');
}

// Document info for visual editing
const documentId = page?._id || '';
const documentType = landingPage ? 'landingPage' : 'page';
// Get header theme from page data (available on both regular pages and landing pages)
const headerTheme = landingPage?.headerTheme || regularPage?.headerTheme || 'default';
---

<Layout title={page?.title || "Page"} headerTheme={headerTheme} announcementBar={landingPage?.announcementBar}>
  {page?.sections?.map((section) => {
    if (section._type === "columnsBlock") {
      const columnsBlock = section as ColumnsBlock;
      const sectionKey = columnsBlock._key;
      return (
        <Columns 
          layout={columnsBlock.layout}
          backgroundColor={columnsBlock.backgroundColor}
          customBackgroundColor={columnsBlock.customBackgroundColor}
          backgroundImage={columnsBlock.backgroundImage?.asset?.url}
          backgroundPosition={columnsBlock.backgroundPosition}
          backgroundSize={columnsBlock.backgroundSize}
          backgroundGradient={columnsBlock.backgroundGradient}
          gradientColorStart={columnsBlock.gradientColorStart}
          gradientColorEnd={columnsBlock.gradientColorEnd}
          paddingTop={columnsBlock.paddingTop}
          paddingTopMobile={columnsBlock.paddingTopMobile}
          paddingBottom={columnsBlock.paddingBottom}
          paddingBottomMobile={columnsBlock.paddingBottomMobile}
          sectionKey={sectionKey}
          documentId={documentId}
          documentType={documentType}
        >
          <ColumnContent 
            slot="col1" 
            content={columnsBlock.column1}
            columnName="column1"
            sectionKey={sectionKey}
            documentId={documentId}
            documentType={documentType}
          />
          {columnsBlock.column2 && <ColumnContent 
            slot="col2" 
            content={columnsBlock.column2}
            columnName="column2"
            sectionKey={sectionKey}
            documentId={documentId}
            documentType={documentType}
          />}
          {columnsBlock.column3 && <ColumnContent 
            slot="col3" 
            content={columnsBlock.column3}
            columnName="column3"
            sectionKey={sectionKey}
            documentId={documentId}
            documentType={documentType}
          />}
          {columnsBlock.column4 && <ColumnContent 
            slot="col4" 
            content={columnsBlock.column4}
            columnName="column4"
            sectionKey={sectionKey}
            documentId={documentId}
            documentType={documentType}
          />}
        </Columns>
      );
    } else if (section._type === "post") {
      const post = section as Post;
      return <Card post={post} />;
    }
  })}
</Layout>
