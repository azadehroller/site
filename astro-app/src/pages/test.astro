---
import Columns from "../components/blocks/Columns.astro";
import ColumnContent from "../components/blocks/ColumnContent.astro";
import Layout from "../layouts/Layout.astro";
import { loadQuery } from "../utils/loadQuery";
import groq from "groq";
import type { ColumnsBlock, Divider } from "../utils/sanity";

// SSR enabled for preview/draft mode
export const prerender = false;

// Define TestPage interface
interface TestPage {
  _id: string;
  _type: "testPage";
  title?: string;
  sections?: (ColumnsBlock | Divider)[];
}

// Query for the test page
const { data: testPage } = await loadQuery<TestPage | null>({
  query: groq`*[_type == "testPage"][0]{
    _id,
    title,
    sections[]{
      ...,
      _type == 'columnsBlock' => {
        _type,
        _key,
        layout,
        backgroundColor,
        customBackgroundColor,
        backgroundImage{ asset-> },
        backgroundPosition,
        backgroundSize,
        paddingTop,
        paddingTopMobile,
        paddingBottom,
        paddingBottomMobile,
        paddingLeft,
        paddingLeftMobile,
        paddingRight,
        paddingRightMobile,
        column1PaddingBottomMobile,
        column2PaddingBottomMobile,
        column3PaddingBottomMobile,
        column4PaddingBottomMobile,
        column1[]{
          ...,
          _type == 'featuresDetail' => {
            _type,
            _key,
            content {
              eyebrow,
              title,
              text
            },
            features[]{
              _key,
              icon,
              iconAsImage{ asset->{ _ref, url } },
              image{ asset->{ _ref, url, metadata{ dimensions } }, alt },
              title,
              text,
              linkLabel,
              link {
                href,
                openInNewTab,
                noFollow
              }
            },
            styles {
              layout,
              contentLayout,
              spacing {
                marginBottom
              }
            }
          }
        },
        column2[]{
          ...,
          _type == 'featuresDetail' => {
            _type,
            _key,
            content {
              eyebrow,
              title,
              text
            },
            features[]{
              _key,
              icon,
              iconAsImage{ asset->{ _ref, url } },
              image{ asset->{ _ref, url, metadata{ dimensions } }, alt },
              title,
              text,
              linkLabel,
              link {
                href,
                openInNewTab,
                noFollow
              }
            },
            styles {
              layout,
              contentLayout,
              spacing {
                marginBottom
              }
            }
          }
        }
      }
    }
  }`,
  request: Astro.request,
});

if (!testPage) {
  return Astro.redirect('/404');
}

// Document info for visual editing
const documentId = testPage?._id || '';
const documentType = 'testPage';
---

<Layout title={testPage?.title || "Test Page"}>
  <div class="test-page-container">
    {testPage?.sections?.map((section: ColumnsBlock | Divider) => {
      if (section._type === "columnsBlock") {
        const columnsBlock = section as ColumnsBlock;
        const sectionKey = columnsBlock._key;
        return (
          <Columns 
            layout={columnsBlock.layout}
            backgroundColor={columnsBlock.backgroundColor}
            customBackgroundColor={columnsBlock.customBackgroundColor}
            backgroundImage={columnsBlock.backgroundImage?.asset?.url}
            backgroundPosition={columnsBlock.backgroundPosition}
            backgroundSize={columnsBlock.backgroundSize}
            paddingTop={columnsBlock.paddingTop}
            paddingTopMobile={columnsBlock.paddingTopMobile}
            paddingBottom={columnsBlock.paddingBottom}
            paddingBottomMobile={columnsBlock.paddingBottomMobile}
            paddingLeft={columnsBlock.paddingLeft}
            paddingLeftMobile={columnsBlock.paddingLeftMobile}
            paddingRight={columnsBlock.paddingRight}
            paddingRightMobile={columnsBlock.paddingRightMobile}
            sectionKey={sectionKey}
            documentId={documentId}
            documentType={documentType}
          >
            <ColumnContent 
              slot="col1" 
              content={columnsBlock.column1}
              columnName="column1"
              sectionKey={sectionKey}
              documentId={documentId}
              documentType={documentType}
            />
            {columnsBlock.column2 && <ColumnContent 
              slot="col2" 
              content={columnsBlock.column2}
              columnName="column2"
              sectionKey={sectionKey}
              documentId={documentId}
              documentType={documentType}
            />}
            {columnsBlock.column3 && <ColumnContent 
              slot="col3" 
              content={columnsBlock.column3}
              columnName="column3"
              sectionKey={sectionKey}
              documentId={documentId}
              documentType={documentType}
            />}
            {columnsBlock.column4 && <ColumnContent 
              slot="col4" 
              content={columnsBlock.column4}
              columnName="column4"
              sectionKey={sectionKey}
              documentId={documentId}
              documentType={documentType}
            />}
          </Columns>
        );
      }
    })}
  </div>
</Layout>
